<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment - King Taper</title>
    <link rel="stylesheet" href="new.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="client-config.js"></script>
    <script src="new.js"></script>
    <!-- Safari compatibility polyfills -->
    <script>
      // Safari fetch polyfill and compatibility fixes
      if (!window.fetch) {
        console.warn('Fetch not supported, loading polyfill...');
        // Basic fetch polyfill for older Safari versions
        window.fetch = function(url, options) {
          return new Promise(function(resolve, reject) {
            var xhr = new XMLHttpRequest();
            xhr.open(options.method || 'GET', url);
            
            if (options.headers) {
              Object.keys(options.headers).forEach(function(key) {
                xhr.setRequestHeader(key, options.headers[key]);
              });
            }
            
            xhr.onload = function() {
              resolve({
                ok: xhr.status >= 200 && xhr.status < 300,
                status: xhr.status,
                json: function() {
                  return Promise.resolve(JSON.parse(xhr.responseText));
                }
              });
            };
            
            xhr.onerror = function() {
              reject(new Error('Network error'));
            };
            
            xhr.send(options.body);
          });
        };
      }
      
      // Safari date parsing fix
      if (!Date.prototype.toISOString) {
        Date.prototype.toISOString = function() {
          function pad(number) {
            if (number < 10) {
              return '0' + number;
            }
            return number;
          }
          return this.getUTCFullYear() +
            '-' + pad(this.getUTCMonth() + 1) +
            '-' + pad(this.getUTCDate()) +
            'T' + pad(this.getUTCHours()) +
            ':' + pad(this.getUTCMinutes()) +
            ':' + pad(this.getUTCSeconds()) +
            '.' + (this.getUTCMilliseconds() / 1000).toFixed(3).slice(2, 5) +
            'Z';
        };
      }
    </script>
    <style>
        .booking-hero {
            background: linear-gradient(120deg, var(--primary) 60%, var(--secondary) 100%);
            color: var(--light);
            padding: 4rem 2rem;
            text-align: center;
        }

        .booking-hero h1 {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .booking-hero p {
            font-size: 1.4rem;
            color: var(--light);
        }

        .booking-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 4rem 2rem;
        }

        .booking-form {
            background: var(--light);
            border: 2px solid var(--accent);
            border-radius: var(--radius);
            padding: 3rem;
            box-shadow: var(--shadow);
            /* Safari compatibility */
            -webkit-appearance: none;
            -webkit-border-radius: var(--radius);
        }
        
        /* Safari input compatibility */
        input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select, textarea {
            -webkit-appearance: none;
            -webkit-border-radius: 8px;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            -webkit-user-select: text;
        }
        
        /* Safari date input specific fixes */
        input[type="date"] {
            -webkit-appearance: none;
            -webkit-border-radius: 8px;
            position: relative;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            -webkit-appearance: none;
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--gray);
            border-radius: var(--radius);
            font-size: 1rem;
            background: #fff;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--accent);
            outline: none;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .submit-btn {
            background: var(--accent);
            color: var(--primary);
            border: 2px solid var(--accent);
            padding: 1.2rem 3rem;
            border-radius: var(--radius);
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1rem;
        }

        .submit-btn:hover {
            background: var(--gold-dark);
            border-color: var(--gold-dark);
            color: var(--light);
        }
        
        #booking-error {
            background: #ffe6e6;
            border: 2px solid #ff6b6b;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-weight: bold;
            text-align: center;
        }
        
        .success-message {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            color: #155724;
            text-align: center;
            font-weight: bold;
        }

        .service-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .service-option {
            background: var(--primary);
            color: var(--light);
            padding: 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .service-option:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .service-option.selected {
            border-color: var(--accent);
            background: var(--accent);
            color: var(--primary);
        }

        .service-price {
            font-size: 0.9rem;
            color: var(--accent);
            margin-top: 0.5rem;
        }

        .service-duration {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 0.3rem;
            font-style: italic;
        }

        .service-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
        }

        .duration-badge {
            background: var(--primary);
            color: var(--light);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            text-align: center;
            min-width: 60px;
        }

        .service-option:hover .duration-badge {
            background: var(--accent);
            color: var(--primary);
        }

        .success-message {
            background: #4CAF50;
            color: white;
            padding: 1rem;
            border-radius: var(--radius);
            margin-top: 1rem;
            text-align: center;
            display: none;
        }

        .fully-booked {
            color: #ff6b6b !important;
            font-weight: bold !important;
            background: #ffe6e6 !important;
            border: 2px solid #ff6b6b !important;
            cursor: not-allowed !important;
        }
        
        .fully-booked option {
            color: #ff6b6b !important;
            background: #ffe6e6 !important;
        }

        .time-select-disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .admin-not-available {
            background-color: #f8d7da !important;
            color: #dc3545 !important;
            border-color: #dc3545 !important;
        }

        .admin-not-available-animation {
            animation: adminNotAvailablePulse 2s ease-in-out infinite;
        }

        @keyframes adminNotAvailablePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .time-select-loading {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }

        .slot-updated {
            animation: slotUpdate 0.5s ease-in-out;
        }

        @keyframes slotUpdate {
            0% { background-color: #fff3cd; }
            50% { background-color: #d4edda; }
            100% { background-color: transparent; }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .booking-form {
                padding: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="index.html">
                    <img src="./newlogo.png" alt="King Taper Logo" class="logo-img" style="display: block;">
                </a>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">Home</a>
                </li>
                <li class="nav-item">
                    <a href="about.html" class="nav-link">About</a>
                </li>
                <li class="nav-item">
                    <a href="services/hair.html" class="nav-link">Services</a>
                </li>
                <li class="nav-item">
                    <a href="index.html#contact" class="nav-link">Contact</a>
                </li>
            </ul>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Booking Hero -->
    <section class="booking-hero">
        <div class="container">
            <h1>Book Your Appointment</h1>
            <p>Schedule your premium grooming experience with King Taper</p>
        </div>
    </section>

    <!-- Booking Form -->
    <section class="booking-container">
        <form class="booking-form" id="bookingForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="firstName">First Name *</label>
                    <input type="text" id="firstName" name="firstName" required>
                </div>
                <div class="form-group">
                    <label for="lastName">Last Name *</label>
                    <input type="text" id="lastName" name="lastName" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email">
                </div>
                <div class="form-group">
                    <label for="phone">Phone Number *</label>
                    <input type="tel" id="phone" name="phone" required>
                </div>
            </div>

            <div class="form-group">
                <label>Select Service *</label>
                <div class="service-options">
                    <div class="service-option" data-service="Hair Cut" data-price="500">
                        <strong>Hair Cut</strong>
                        <div class="service-info">
                            <div class="service-price">KSH 500</div>
                            <div class="duration-badge">30 min</div>
                        </div>
                    </div>
                    <div class="service-option" data-service="Kids Cut" data-price="300">
                        <strong>Kids Cut</strong>
                        <div class="service-info">
                            <div class="service-price">KSH 300</div>
                            <div class="duration-badge">30 min</div>
                        </div>
                    </div>
                    <div class="service-option" data-service="Coils & Haircut" data-price="1500">
                        <strong>Coils & Haircut</strong>
                        <div class="service-info">
                            <div class="service-price">KSH 1,500</div>
                            <div class="duration-badge">1h 30m</div>
                        </div>
                    </div>
                    <div class="service-option" data-service="Barrel Twist" data-price="1000">
                        <strong>Barrel Twist</strong>
                        <div class="service-info">
                            <div class="service-price">KSH 1,000</div>
                            <div class="duration-badge">1h 30m</div>
                        </div>
                    </div>
                    <div class="service-option" data-service="Home Service" data-price="1500">
                        <strong>Home Service</strong>
                        <div class="service-info">
                            <div class="service-price">KSH 1,500</div>
                            <div class="duration-badge">1h 30m</div>
                        </div>
                    </div>
                    <div class="service-option" data-service="Hair Color" data-price="500">
                        <strong>Hair Color</strong>
                        <div class="service-info">
                            <div class="service-price">KSH 500</div>
                            <div class="duration-badge">1 hour</div>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="selectedService" name="selectedService" required>
                <input type="hidden" id="selectedPrice" name="selectedPrice" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="date">Preferred Date *</label>
                    <input type="date" id="date" name="date" required min="">
                    <small style="color: #ff6b6b; font-weight: bold; display: block; margin-top: 0.5rem;">
                        <i class="fa fa-info-circle"></i> We are closed on Tuesdays
                    </small>
                </div>
                <div class="form-group">
                    <label for="time">Preferred Time *</label>
                    <div id="service-duration-info" style="font-size: 0.9rem; margin-bottom: 0.5rem; color: #666; display: none;">
                        <i class="fa fa-clock"></i> <span id="duration-text"></span>
                    </div>
                    <select id="time" name="time" required>
                        <option value="">Select a service first to see available times</option>
                    </select>
                    <div id="time-status" style="font-size: 0.9rem; margin-top: 0.5rem; color: #666; display: none;">
                        <i class="fa fa-sync-alt fa-spin"></i> Auto-updating available slots...
                    </div>

                </div>
            </div>

            <div class="form-group">
                <label for="message">Additional Notes</label>
                <textarea id="message" name="message" rows="4" placeholder="Any special requests or additional information..."></textarea>
            </div>

            <div id="booking-error" style="display:none;color:#ff6b6b;text-align:center;margin-bottom:1rem;font-weight:bold;"></div>

            <button type="submit" class="submit-btn" id="submitBtn">Book Appointment</button>
        </form>

        <div class="success-message" id="successMessage">
            Thank you! Your appointment has been booked successfully. We'll confirm your booking via WhatsApp shortly.
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer-modern slide-in">
      <div class="footer-main">
        <div class="footer-col footer-contact">
          <h3 class="footer-title-red">Contact Us</h3>
          <ul class="footer-contact-list">
            <li><span class="footer-icon">📍</span> Mombasa, Kenya</li>
            <li><span class="footer-icon">📞</span> +254 5790 4681</li>
            <li><span class="footer-icon">✉️</span> Symog49@icloud.com</li>
          </ul>
        </div>
        <div class="footer-col footer-center">
          <img src="newlogo.png" alt="King Taper Logo" class="footer-logo-modern">
          <h2 class="footer-brand-modern">King Taper</h2>
          <div class="footer-tagline">Premium Grooming Services</div>
        </div>
        <div class="footer-col footer-links">
          <h3 class="footer-title-red">Quick Links</h3>
          <ul class="footer-links-list">
            <li><a href="about.html">About</a></li>
                            <li><a href="index.html#contact">Contact</a></li>
            <li><a href="booking.html">Book</a></li>
            <li><a href="services/hair.html">Services</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-separator"></div>
      <div class="footer-bottom-modern">
        <div class="footer-social-icons">
          <a href="https://www.instagram.com/king_ngotho?utm_source=qr" class="footer-social-circle" target="_blank" rel="noopener noreferrer"><i class="fa-brands fa-instagram" aria-hidden="true"></i></a>
          <a href="https://www.tiktok.com/@king_taper?_r=1&_d=ejli5iekmj7541&sec_uid=MS4wLjABAAAAFJBnJ9giNgBN1xKspotzcHMe110YTJfVz38JHWlkqORShclQQT_23PPXStxzvwX9&share_author_id=7131257623361520646&sharer_language=en&source=h5_m&u_code=e39a894g227354&ug_btm=b8727,b0&social_share_type=4&utm_source=copy&sec_user_id=MS4wLjABAAAAFJBnJ9giNgBN1xKspotzcHMe110YTJfVz38JHWlkqORShclQQT_23PPXStxzvwX9&tt_from=copy&utm_medium=ios&utm_campaign=client_share&enable_checksum=1&user_id=7131257623361520646&share_link_id=62C7907B-F4B3-4CB7-AC69-506DDA270913&share_app_id=1233" class="footer-social-circle" target="_blank" rel="noopener noreferrer"><i class="fa-brands fa-tiktok" aria-hidden="true"></i></a>
        </div>
      </div>
      <div class="footer-copyright">
        &copy; 2025 King Taper. All rights reserved.
      </div>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
          // Set minimum date to today for date picker - Safari compatible
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          const todayString = `${year}-${month}-${day}`;
          document.getElementById('date').min = todayString;
          
          // Get date input element
          const dateInput = document.getElementById('date');
          
          // Function to handle date changes and Tuesday restrictions
          function handleDateChange() {
            if (!dateInput.value) {
              return;
            }
            
            // Parse date correctly to avoid timezone issues
            const selectedDate = new Date(dateInput.value + 'T00:00:00');
            const dayOfWeek = selectedDate.getDay(); // 0 = Sunday, 1 = Monday, 2 = Tuesday
            
            // Check if selected date is Tuesday (day 2)
            if (dayOfWeek === 2) {
              // Clear time selection and show Tuesday off message
              timeSelect.innerHTML = '<option value="">We are closed on Tuesdays</option>';
              timeSelect.disabled = true;
              timeSelect.classList.add('time-select-disabled');
              timeSelect.classList.add('tuesday-closed');
              
              // Show Tuesday off message
              const timeStatus = document.getElementById('time-status');
              if (timeStatus) {
                timeStatus.innerHTML = '<i class="fa fa-calendar-times"></i> <strong>CLOSED ON TUESDAYS</strong> - We are off on Tuesdays. Please select another day for your appointment.';
                timeStatus.style.display = 'block';
                timeStatus.style.color = '#ff6b6b';
                timeStatus.style.fontWeight = 'bold';
                timeStatus.style.background = '#ffe6e6';
                timeStatus.style.padding = '0.5rem';
                timeStatus.style.borderRadius = '4px';
                timeStatus.style.border = '1px solid #ff6b6b';
                timeStatus.classList.add('tuesday-closed-animation');
              }
              return; // Don't proceed with fetching time slots
            }
            
            // Not Tuesday - proceed with normal flow
            const selectedService = selectedServiceInput.value;
            if (selectedService) {
              highlightBookedTimes(dateInput.value, selectedService);
            }
          }
        
          // Service selection logic
          const serviceOptions = document.querySelectorAll('.service-option');
          const selectedServiceInput = document.getElementById('selectedService');
          const selectedPriceInput = document.getElementById('selectedPrice');
          const timeSelect = document.getElementById('time');
          const submitBtn = document.getElementById('submitBtn');

          // PERFORMANCE IMPROVEMENT: Simple cache for booked times
          const bookedTimesCache = new Map();
          const CACHE_DURATION = 2 * 60 * 1000; // 2 minutes

          // Helper function to get service duration
          function getServiceDuration(service) {
            const durations = {
              'Hair Cut': 30,        // 30 minutes
              'Kids Cut': 30,        // 30 minutes
              'Coils & Haircut': 90, // 1 hour 30 minutes
              'Barrel Twist': 90,    // 1 hour 30 minutes
              'Home Service': 90,    // 1 hour 30 minutes
              'Hair Color': 60       // 1 hour
            };
            return durations[service] || 30;
          }

          // Helper function to generate time slots based on service duration
          function generateTimeSlotsForService(duration) {
            // Validate duration
            if (!duration || duration <= 0) {
              console.error('Invalid duration:', duration);
              return [];
            }
            
            const slots = [];
            const startHour = 9; // 9 AM
            const endHour = 21;  // 9 PM
            
            // Always use 30-minute intervals for slot generation
            // The duration affects how many slots are blocked, not the slot size
            const slotInterval = 30;
            
            console.log(`Generating time slots: service duration=${duration}min, slot interval=${slotInterval}min`);
            
            for (let hour = startHour; hour < endHour; hour++) {
              for (let minute = 0; minute < 60; minute += slotInterval) {
                // Format time as HH:MM
                const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                slots.push(timeString);
              }
            }
            
            console.log(`Generated ${slots.length} time slots:`, slots);
            return slots;
          }

          // Helper function to check if a time slot has passed for today
          function isTimeSlotPassed(timeString, selectedDate) {
            const today = new Date();
            const selectedDateObj = new Date(selectedDate);
            
            // If it's not today, all time slots are available
            if (selectedDateObj.toDateString() !== today.toDateString()) {
              return false;
            }
            
            // For today, check if the time has passed
            const currentTime = today.getHours() * 60 + today.getMinutes(); // Current time in minutes
            const [hours, minutes] = timeString.split(':').map(Number);
            const slotTime = hours * 60 + minutes; // Slot time in minutes
            
            // Add 15 minutes buffer to prevent very tight bookings
            return slotTime <= (currentTime + 15);
          }

          // Helper function to handle blocked days
          function handleBlockedDay(reason) {
            console.log('Day is blocked:', reason);
            
            // Clear the time select and disable it
            timeSelect.innerHTML = '<option value="">ADMIN NOT AVAILABLE</option>';
            timeSelect.disabled = true;
            timeSelect.classList.add('time-select-disabled');
            timeSelect.classList.add('admin-not-available');
            
            // Show admin not available message
            const timeStatus = document.getElementById('time-status');
            if (timeStatus) {
              const reasonText = reason ? ` - ${reason}` : '';
              timeStatus.innerHTML = `<i class="fa fa-user-times"></i> <strong>ADMIN NOT AVAILABLE</strong>${reasonText} - This day is blocked. Please select another date.`;
              timeStatus.style.display = 'block';
              timeStatus.style.color = '#dc3545';
              timeStatus.style.fontWeight = 'bold';
              timeStatus.style.background = '#f8d7da';
              timeStatus.style.padding = '0.5rem';
              timeStatus.style.borderRadius = '4px';
              timeStatus.style.border = '1px solid #dc3545';
              timeStatus.classList.add('admin-not-available-animation');
            }
            
            // Remove loading state
            timeSelect.classList.remove('time-select-loading');
          }

          // Helper function to handle fully booked days
          function handleFullyBookedDay(reason) {
            console.log('Day is fully booked:', reason);
            
            // Clear the time select and disable it
            timeSelect.innerHTML = '<option value="">FULLY BOOKED - No available slots</option>';
            timeSelect.disabled = true;
            timeSelect.classList.add('time-select-disabled');
            timeSelect.classList.add('fully-booked');
            
            // Show fully booked message
            const timeStatus = document.getElementById('time-status');
            if (timeStatus) {
              const reasonText = reason ? ` - ${reason}` : '';
              timeStatus.innerHTML = `<i class="fa fa-calendar-times"></i> <strong>FULLY BOOKED</strong>${reasonText} - All time slots for this date and service are taken. Please select another date.`;
              timeStatus.style.display = 'block';
              timeStatus.style.color = '#ff6b6b';
              timeStatus.style.fontWeight = 'bold';
              timeStatus.style.background = '#ffe6e6';
              timeStatus.style.padding = '0.5rem';
              timeStatus.style.borderRadius = '4px';
              timeStatus.style.border = '1px solid #ff6b6b';
              timeStatus.classList.add('tuesday-closed-animation');
            }
            
            // Remove loading state
            timeSelect.classList.remove('time-select-loading');
          }

          // Direct function to display available times from API (no filtering needed)
          function updateTimeSelectDirect(availableTimes, selectedService, selectedDate) {
            console.log('Available times from API:', availableTimes);
            console.log('Service:', selectedService, 'Date:', selectedDate);
            
            // Clear the time select
            timeSelect.innerHTML = '';
            
            if (availableTimes.length === 0) {
              timeSelect.innerHTML = '<option value="">No available slots</option>';
              timeSelect.disabled = true;
              timeSelect.classList.add('time-select-disabled');
              
              // Hide status message when no slots available
              const timeStatus = document.getElementById('time-status');
              if (timeStatus) {
                timeStatus.style.display = 'none';
              }
              return;
            }
            
            // Add placeholder option first
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = `Select Time (${availableTimes.length} slots available)`;
            timeSelect.appendChild(placeholderOption);
            
            // Add available times directly with range format
            // DOUBLE-CHECK: Only add times that are actually available
            availableTimes.forEach(time => {
              // Additional validation to ensure this time is truly available
              if (!time || time === '') {
                console.warn('Skipping invalid time slot:', time);
                return;
              }
              
              const option = document.createElement('option');
              option.value = time;
              
              // Convert time to range format based on service duration
              const [hours, minutes] = time.split(':').map(Number);
              const serviceDuration = getServiceDuration(selectedService);
              
              // Calculate end time properly
              const totalMinutes = hours * 60 + minutes + serviceDuration;
              const endHours = Math.floor(totalMinutes / 60);
              const endMinutes = totalMinutes % 60;
              const endTimeString = `${endHours.toString().padStart(2, '0')}:${endMinutes.toString().padStart(2, '0')}`;
              
              option.textContent = `${time}-${endTimeString}`;
              timeSelect.appendChild(option);
              
              console.log(`✅ Added available time slot: ${time}-${endTimeString}`);
            });
            
            // Enable the select
            timeSelect.disabled = false;
            timeSelect.classList.remove('time-select-disabled');
            
            // Update status message
            const timeStatus = document.getElementById('time-status');
            if (timeStatus) {
              const slotText = availableTimes.length === 1 ? 'time slot' : 'time slots';
              timeStatus.innerHTML = `<i class="fa fa-calendar-check"></i> <strong>${availableTimes.length} ${slotText} available</strong> for ${selectedService}`;
              timeStatus.style.display = 'block';
              timeStatus.style.backgroundColor = '#d4edda';
              timeStatus.style.color = '#155724';
              timeStatus.style.border = '1px solid #c3e6cb';
            }
            
            console.log(`Displayed ${availableTimes.length} available time slots`);
          }

          // Update the time slot generation to be dynamic based on service duration
          function updateTimeSelect(bookedTimes, selectedService, selectedDate) {
            const booked = new Set(bookedTimes);
            console.log('Booked times received:', Array.from(booked));
            console.log('Booked times type:', typeof bookedTimes, 'Length:', bookedTimes.length);
            
            // Get service duration
            const serviceDuration = getServiceDuration(selectedService);
            console.log('Service duration for', selectedService, ':', serviceDuration, 'minutes');
            
            // Generate time slots based on service duration
            const timeSlots = generateTimeSlotsForService(serviceDuration);
            console.log('Generated time slots for', selectedService, ':', timeSlots);
            
            // Clear the time select
            timeSelect.innerHTML = '';
            
            // Filter out booked times and past times
            const availableTimes = timeSlots.filter(time => {
              const isBooked = booked.has(time);
              const isPassed = isTimeSlotPassed(time, selectedDate);
              
              if (isPassed) {
                console.log(`Time slot ${time} filtered out - already passed`);
              }
              if (isBooked) {
                console.log(`Time slot ${time} filtered out - already booked`);
              }
              
              return !isBooked && !isPassed;
            });
            
            console.log(`Total slots: ${timeSlots.length}, Booked: ${booked.size}, Past: ${timeSlots.length - booked.size - availableTimes.length}, Available: ${availableTimes.length}`);
            console.log('Available times:', availableTimes);
            
            if (availableTimes.length === 0) {
              // Check if it's because all slots are in the past for today
              const selectedDateObj = new Date(selectedDate);
              const today = new Date();
              const isToday = selectedDateObj.toDateString() === today.toDateString();
              
              // Count actual past times (not just non-booked slots)
              let actualPastTimesCount = 0;
              if (isToday) {
                timeSlots.forEach(time => {
                  if (isTimeSlotPassed(time, selectedDate)) {
                    actualPastTimesCount++;
                  }
                });
              }
              
              if (isToday && actualPastTimesCount > 0 && actualPastTimesCount === (timeSlots.length - booked.size)) {
                // All non-booked slots are in the past for today
                timeSelect.innerHTML = '<option value="">ALL SLOTS IN THE PAST - Please select tomorrow or later</option>';
                timeSelect.disabled = true;
                timeSelect.classList.add('time-select-disabled');
                timeSelect.classList.add('past-times');
                
                // Show past times message
                const timeStatus = document.getElementById('time-status');
                if (timeStatus) {
                  timeStatus.innerHTML = '<i class="fa fa-clock"></i> <strong>ALL SLOTS IN THE PAST</strong> - All available time slots for today have already passed. Please select tomorrow or a future date.';
                  timeStatus.style.display = 'block';
                  timeStatus.style.color = '#ff8c00';
                  timeStatus.style.fontWeight = 'bold';
                  timeStatus.style.background = '#fff3cd';
                  timeStatus.style.padding = '0.5rem';
                  timeStatus.style.borderRadius = '4px';
                  timeStatus.style.border = '1px solid #ff8c00';
                  timeStatus.classList.add('past-times-animation');
                }
              } else if (timeSlots.length === 0) {
                // No time slots generated - likely a blocked day
                timeSelect.innerHTML = '<option value="">ADMIN NOT AVAILABLE</option>';
                timeSelect.disabled = true;
                timeSelect.classList.add('time-select-disabled');
                timeSelect.classList.add('admin-not-available');
                
                // Show admin not available message
                const timeStatus = document.getElementById('time-status');
                if (timeStatus) {
                  timeStatus.innerHTML = '<i class="fa fa-user-times"></i> <strong>ADMIN NOT AVAILABLE</strong> - This day is blocked. Please select another date.';
                  timeStatus.style.display = 'block';
                  timeStatus.style.color = '#dc3545';
                  timeStatus.style.fontWeight = 'bold';
                  timeStatus.style.background = '#f8d7da';
                  timeStatus.style.padding = '0.5rem';
                  timeStatus.style.borderRadius = '4px';
                  timeStatus.style.border = '1px solid #dc3545';
                  timeStatus.classList.add('admin-not-available-animation');
                }
              } else {
                // All slots are booked
                timeSelect.innerHTML = '<option value="">FULLY BOOKED - No available slots</option>';
                timeSelect.disabled = true;
                timeSelect.classList.add('time-select-disabled');
                timeSelect.classList.add('fully-booked');
                
                // Show a more prominent message
                const timeStatus = document.getElementById('time-status');
                if (timeStatus) {
                  timeStatus.innerHTML = '<i class="fa fa-calendar-times"></i> <strong>FULLY BOOKED</strong> - All time slots for this date and service are taken. Please select another date.';
                  timeStatus.style.display = 'block';
                  timeStatus.style.color = '#ff6b6b';
                  timeStatus.style.fontWeight = 'bold';
                  timeStatus.style.background = '#ffe6e6';
                  timeStatus.style.padding = '0.5rem';
                  timeStatus.style.borderRadius = '4px';
                  timeStatus.style.border = '1px solid #ff6b6b';
                  timeStatus.classList.add('tuesday-closed-animation');
                }
              }
            } else {
              // Add placeholder and available times
              timeSelect.innerHTML = `<option value="">Select Time (${availableTimes.length} slots available)</option>`;
              
              // Show availability status
              const timeStatus = document.getElementById('time-status');
              if (timeStatus) {
                const slotText = availableTimes.length === 1 ? 'time slot' : 'time slots';
                timeStatus.innerHTML = `<i class="fa fa-calendar-check"></i> <strong>${availableTimes.length} ${slotText} available</strong> for ${selectedService}`;
                timeStatus.style.display = 'block';
                timeStatus.style.color = '#28a745';
                timeStatus.style.fontWeight = 'bold';
                timeStatus.style.background = '#d4edda';
                timeStatus.style.padding = '0.5rem';
                timeStatus.style.borderRadius = '4px';
                timeStatus.style.border = '1px solid #28a745';
              }
              
              availableTimes.forEach(time => {
                const opt = document.createElement('option');
                opt.value = time;
                
                // Calculate end time for display
                const [hours, minutes] = time.split(':').map(Number);
                const totalMinutes = hours * 60 + minutes + serviceDuration;
                const endHours = Math.floor(totalMinutes / 60);
                const endMinutes = totalMinutes % 60;
                const endTimeString = `${endHours.toString().padStart(2, '0')}:${endMinutes.toString().padStart(2, '0')}`;
                
                // Format display text with duration info
                const displayText = time.replace(/^(\d{1,2}):(\d{2})$/, (m, h, min) => {
                  let hour = parseInt(h, 10);
                  let ampm = hour >= 12 ? 'PM' : 'AM';
                  if (hour > 12) hour -= 12;
                  if (hour === 0) hour = 12;
                  return `${hour}:${min} ${ampm}`;
                });
                
                opt.textContent = `${displayText} - ${endTimeString.replace(/^(\d{1,2}):(\d{2})$/, (m, h, min) => {
                  let hour = parseInt(h, 10);
                  let ampm = hour >= 12 ? 'PM' : 'AM';
                  if (hour > 12) hour -= 12;
                  if (hour === 0) hour = 12;
                  return `${hour}:${min} ${ampm}`;
                })} (${serviceDuration} min)`;
                
                timeSelect.appendChild(opt);
              });
              timeSelect.disabled = false;
              timeSelect.classList.remove('time-select-disabled');
              timeSelect.classList.remove('fully-booked');
            }
            
            // Remove loading state and add update animation
            timeSelect.classList.remove('time-select-loading');
            timeSelect.classList.add('slot-updated');
            setTimeout(() => timeSelect.classList.remove('slot-updated'), 500);
            
            // Hide status message
            const timeStatus = document.getElementById('time-status');
            if (timeStatus) timeStatus.style.display = 'none';
          }

          // Update the highlightBookedTimes function to include service parameter
          function highlightBookedTimes(date, service) {
            if (!date) {
              console.warn('No date provided to highlightBookedTimes');
              return;
            }
            
            if (!service) {
              console.warn('No service provided to highlightBookedTimes');
              return;
            }
            
            // Check if selected date is Tuesday (day 2)
            const selectedDate = new Date(date);
            const dayOfWeek = selectedDate.getDay();
            if (dayOfWeek === 2) {
              // Clear time selection and show Tuesday off message
              timeSelect.innerHTML = '<option value="">We are closed on Tuesdays</option>';
              timeSelect.disabled = true;
              timeSelect.classList.add('time-select-disabled');
              timeSelect.classList.add('tuesday-closed');
              
              // Show Tuesday off message
              const timeStatus = document.getElementById('time-status');
              if (timeStatus) {
                timeStatus.innerHTML = '<i class="fa fa-calendar-times"></i> <strong>CLOSED ON TUESDAYS</strong> - We are off on Tuesdays. Please select another day for your appointment.';
                timeStatus.style.display = 'block';
                timeStatus.style.color = '#ff6b6b';
                timeStatus.style.fontWeight = 'bold';
                timeStatus.style.background = '#ffe6e6';
                timeStatus.style.padding = '0.5rem';
                timeStatus.style.borderRadius = '4px';
                timeStatus.style.border = '1px solid #ff6b6b';
              }
              return; // Don't proceed with fetching time slots
            }
            
            console.log('Fetching booked times for date:', date, 'and service:', service);
            
            // DISABLE CACHING - Always fetch fresh data to prevent showing booked slots
            // This ensures users never see booked time slots as available
            console.log('Fetching fresh data to prevent showing booked slots');
            
            // Show loading state
            timeSelect.classList.add('time-select-loading');
            timeSelect.innerHTML = '<option value="">Loading available times...</option>';
            
            // PERFORMANCE IMPROVEMENT: Add timeout to prevent indefinite loading
            const timeoutId = setTimeout(() => {
              console.warn('API call timeout for date:', date);
              timeSelect.innerHTML = '<option value="">Loading timeout - please try again</option>';
              timeSelect.classList.remove('time-select-loading');
            }, 10000); // 10 second timeout
            
            const apiUrl = window.KingTaperConfig ? window.KingTaperConfig.apiBaseUrl : 'http://localhost:3001';
            // Add cache-busting parameter to ensure fresh data
            const cacheBuster = Date.now();
            fetch(`${apiUrl}/api/available-times?date=${encodeURIComponent(date)}&service=${encodeURIComponent(service)}&_t=${cacheBuster}`)
              .then(res => {
                if (!res.ok) {
                  throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                return res.json();
              })
              .then(data => {
                clearTimeout(timeoutId); // Clear timeout on success
                console.log('Available times response:', data);
                if (!data.success) return;
                
                // Check if the day is blocked
                if (data.blocked) {
                  handleBlockedDay(data.reason);
                  return;
                }
                
                // Check if the day is fully booked
                if (data.fullyBooked) {
                  handleFullyBookedDay(data.reason);
                  return;
                }
                
                // NO CACHING - Always use fresh data to prevent showing booked slots
                // This ensures users never see outdated time slot information
                
                // Filter out past times for TODAY before displaying - Safari compatible
                let filteredTimes = data.times;
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const todayString = `${year}-${month}-${day}`;
                
                if (date === todayString) {
                  const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                  filteredTimes = data.times.filter(time => time > currentTime);
                  console.log(`⏰ Frontend filtered past times for today, current: ${currentTime}, available: ${filteredTimes.length}`);
                }
                
                // Use the filtered times
                updateTimeSelectDirect(filteredTimes, service, date);
              })
              .catch(error => {
                clearTimeout(timeoutId); // Clear timeout on error
                console.error('Error fetching booked times:', error);
                // Fallback to showing all times if API fails
                updateTimeSelect([], service, date);
              });
          }

          // Update service selection to refresh time slots
          serviceOptions.forEach(option => {
            option.addEventListener('click', function() {
              console.log('Service selected:', this.dataset.service, 'Price:', this.dataset.price);
              
              // Remove selection from all options
              serviceOptions.forEach(opt => opt.classList.remove('selected'));
              
              // Add selection to clicked option
              this.classList.add('selected');
              
              // Update hidden inputs
              selectedServiceInput.value = this.dataset.service;
              selectedPriceInput.value = this.dataset.price;
              
              console.log('Hidden inputs updated:', selectedServiceInput.value, selectedPriceInput.value);
              
              // Show service duration info
              const durationInfo = document.getElementById('service-duration-info');
              const durationText = document.getElementById('duration-text');
              const serviceDuration = getServiceDuration(this.dataset.service);
              
              if (serviceDuration >= 60) {
                const hours = Math.floor(serviceDuration / 60);
                const minutes = serviceDuration % 60;
                if (minutes > 0) {
                  durationText.textContent = `Service duration: ${hours}h ${minutes}m`;
                } else {
                  durationText.textContent = `Service duration: ${hours} hour${hours > 1 ? 's' : ''}`;
                }
              } else {
                durationText.textContent = `Service duration: ${serviceDuration} minutes`;
              }
              durationInfo.style.display = 'block';
              
              // Refresh time slots based on new service selection
              if (dateInput.value) {
                highlightBookedTimes(dateInput.value, this.dataset.service);
              } else {
                // If no date selected, show available slots for today - Safari compatible
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const todayString = `${year}-${month}-${day}`;
                highlightBookedTimes(todayString, this.dataset.service);
              }
            });
          });

          // Add event listeners for date changes
          dateInput.addEventListener('change', handleDateChange);

          // Function to reset time selection when no service is selected
          function resetTimeSelection() {
            timeSelect.innerHTML = '<option value="">Select a service first to see available times</option>';
            timeSelect.disabled = true;
            timeSelect.classList.add('time-select-disabled');
            timeSelect.classList.remove('fully-booked');
            
            // Hide duration info
            const durationInfo = document.getElementById('service-duration-info');
            durationInfo.style.display = 'none';
            
            // Clear status message
            const timeStatus = document.getElementById('time-status');
            if (timeStatus) {
              timeStatus.style.display = 'none';
              timeStatus.innerHTML = '';
            }
          }

          // Initial state - disable time selection until service is chosen
          resetTimeSelection();
          
          // Test if the submit button is working
          if (submitBtn) {
            submitBtn.addEventListener('click', function() {
              console.log('Submit button clicked!');
            });
            console.log('✅ Submit button event listener added');
          } else {
            console.error('❌ Submit button not found!');
          }
          
                      // Log system status
            console.log('🚀 King Taper Booking System Initialized');
            console.log('📅 Service Durations:', {
              'Hair Cut': '30 min',
              'Kids Cut': '30 min',
              'Coils & Haircut': '1h 30m',
              'Barrel Twist': '1h 30m',
              'Home Service': '1h 30m',
              'Hair Color': '1h'
            });
            console.log('🔧 API Configuration:', window.KingTaperConfig);
            
            // Validate system configuration
            if (!window.KingTaperConfig || !window.KingTaperConfig.apiBaseUrl) {
              console.error('❌ KingTaperConfig not properly loaded!');
            } else {
              console.log('✅ Configuration loaded successfully');
            }
            
            // Test service duration function
            const testService = 'Barrel Twist';
            const testDuration = getServiceDuration(testService);
            console.log(`🧪 Test: ${testService} duration = ${testDuration} minutes`);
            
            if (testDuration !== 90) {
              console.error('❌ Service duration mismatch! Expected 90, got', testDuration);
            } else {
              console.log('✅ Service duration function working correctly');
            }
          
          // Initial highlight if date is pre-filled
          if (dateInput.value) {
            const selectedService = selectedServiceInput.value;
            if (selectedService) {
              highlightBookedTimes(dateInput.value, selectedService);
            }
          }
          
          // Add a helpful message about the booking system
          const initialTimeStatus = document.getElementById('time-status');
          if (initialTimeStatus) {
            initialTimeStatus.innerHTML = '<i class="fa fa-info-circle"></i> <strong>Tip:</strong> Select a service and date to see available time slots. Booked slots are automatically filtered out. <strong>Note: We are closed on Tuesdays.</strong>';
            initialTimeStatus.style.display = 'block';
            initialTimeStatus.style.color = '#17a2b8';
            initialTimeStatus.style.background = '#d1ecf1';
            initialTimeStatus.style.padding = '0.5rem';
            initialTimeStatus.style.borderRadius = '4px';
            initialTimeStatus.style.border = '1px solid #17a2b8';
          }
          
          // Auto-refresh available times every 2 minutes to catch real-time updates
          let autoRefreshInterval;
          const timeStatus = document.getElementById('time-status');
          
          function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
              if (dateInput.value && !timeSelect.disabled) {
                console.log('Auto-refreshing available time slots...');
                if (timeStatus) {
                  timeStatus.style.display = 'block';
                }
                const selectedService = selectedServiceInput.value;
                if (selectedService) {
                  highlightBookedTimes(dateInput.value, selectedService);
                }
              }
            }, 120000); // 2 minutes
          }
          
          function stopAutoRefresh() {
            if (autoRefreshInterval) {
              clearInterval(autoRefreshInterval);
              autoRefreshInterval = null;
            }
          }
          
          // Start auto-refresh when date is selected
          dateInput.addEventListener('change', function() {
            startAutoRefresh();
          });
          
          // Booking form submission
          console.log('Setting up form submission handler...');
          document.getElementById('bookingForm').addEventListener('submit', function (e) {
            console.log('Form submission triggered!');
            e.preventDefault();
            
            // Stop auto-refresh when form is submitted
            stopAutoRefresh();
            
            // Check if time slots are fully booked
            if (timeSelect.disabled || timeSelect.classList.contains('fully-booked')) {
              document.getElementById('booking-error').textContent = 'Sorry, all time slots for this date and service are fully booked. Please select another date or service.';
              document.getElementById('booking-error').style.display = 'block';
              return;
            }
            
            const formData = new FormData(this);
            
            // Double-check that the selected time is still available
            let selectedTime = formData.get('time');
            if (!selectedTime || selectedTime === '') {
              document.getElementById('booking-error').textContent = 'Please select a valid time slot.';
              document.getElementById('booking-error').style.display = 'block';
              return;
            }
            
            // FINAL VALIDATION: Check if the selected time is actually available
            // This prevents the "Time slot already booked" error
            const availableTimes = Array.from(timeSelect.options)
              .filter(option => option.value !== '')
              .map(option => option.value.split('-')[0]); // Extract start time
            
            if (!availableTimes.includes(selectedTime)) {
              document.getElementById('booking-error').textContent = 'This time slot is no longer available. Please refresh and select another time.';
              document.getElementById('booking-error').style.display = 'block';
              return;
            }
            
            // Extract start time from range format (e.g., "17:00-17:30" -> "17:00")
            if (selectedTime.includes('-')) {
              selectedTime = selectedTime.split('-')[0];
            }
            
            // Debug: Log all form data
            console.log('Form data entries:');
            for (let [key, value] of formData.entries()) {
              console.log(`${key}: ${value}`);
            }
            
            // Validate required fields
            const firstName = formData.get('firstName').trim();
            const lastName = formData.get('lastName').trim();
            const email = formData.get('email').trim();
            const phone = formData.get('phone').trim();
            const service = formData.get('selectedService');
            const date = formData.get('date');
            const time = selectedTime; // Use the extracted start time
            
            // Check for empty required fields
            if (!firstName || !lastName || !phone || !service || !date || !time) {
              document.getElementById('booking-error').textContent = 'Please fill in all required fields (First Name, Last Name, Phone, Service, Date, and Time).';
              document.getElementById('booking-error').style.display = 'block';
              return;
            }
            
            // Validate phone number format (basic validation)
            const phoneRegex = /^(\+254|0)?[17]\d{8}$/;
            if (!phoneRegex.test(phone.replace(/\s/g, ''))) {
              document.getElementById('booking-error').textContent = 'Please enter a valid Kenyan phone number.';
              document.getElementById('booking-error').style.display = 'block';
              return;
            }
            
            // Validate date is not in the past
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (selectedDate < today) {
              document.getElementById('booking-error').textContent = 'Please select a future date for your appointment.';
              document.getElementById('booking-error').style.display = 'block';
              return;
            }
            
            // Check if selected date is Tuesday (day 2)
            const dayOfWeek = selectedDate.getDay();
            if (dayOfWeek === 2) {
              document.getElementById('booking-error').textContent = 'We are closed on Tuesdays. Please select another day for your appointment.';
              document.getElementById('booking-error').style.display = 'block';
              return;
            }
            
            // Show loading state
            submitBtn.textContent = 'Booking...';
            submitBtn.disabled = true;
            document.getElementById('booking-error').style.display = 'none';
            
            const bookingData = {
              name: formData.get('firstName') + ' ' + formData.get('lastName'),
              email: formData.get('email'),
              phone: formData.get('phone'),
              service: formData.get('selectedService'),
              price: formData.get('selectedPrice'),
              date: formData.get('date'),
              time: selectedTime, // Use the extracted start time
              message: formData.get('message')
            };
        
            console.log('Submitting booking to backend:', bookingData);
            
            // Check if KingTaperConfig is available
            let API_URL;
            if (!window.KingTaperConfig || !window.KingTaperConfig.apiBaseUrl) {
              console.error('KingTaperConfig not found, using fallback URL');
              // Use fallback URL based on current hostname
              if (window.location.hostname === 'localhost') {
                API_URL = 'http://localhost:3001/api/book';
              } else {
                API_URL = '/api/book';
              }
            } else {
              // Use the dynamic configuration
              API_URL = window.KingTaperConfig.apiBaseUrl + '/api/book';
            }
            console.log('Server URL:', API_URL);
        
            const message = `New Booking Request:\n
        Name: ${bookingData.name}
        Email: ${bookingData.email || 'Not provided'}
        Phone: ${bookingData.phone}
        Service: ${bookingData.service} (KSH ${bookingData.price})
        Date: ${bookingData.date}
        Time: ${bookingData.time}
        Notes: ${bookingData.message || 'None'}`;
        
            // Open an empty tab immediately to avoid popup blockers
            const waURL = `https://wa.me/254757904681?text=${encodeURIComponent(message)}`;
            const waTab = window.open('', '_blank');
        
            // Add timeout to prevent hanging requests
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
            
            fetch(API_URL, {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify(bookingData),
              signal: controller.signal
            })
            .then(response => {
              clearTimeout(timeoutId); // Clear timeout on response
              console.log('Response status:', response.status);
              console.log('Response headers:', response.headers);
              return response.json();
            })
            .then(data => {
              console.log('Response data:', data);
              if (data.success) {
                console.log('Booking saved to database.');
                waTab.location = waURL; // Open WhatsApp only if booking is successful
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('booking-error').style.display = 'none';
                
                // Automatically refresh available time slots for the booked date
                const bookedDate = bookingData.date;
                if (bookedDate) {
                  console.log('Refreshing available time slots for:', bookedDate);
                  const selectedService = bookingData.service;
                  if (selectedService) {
                    // Force refresh the time slots by calling the API again
                    loadAvailableTimes(bookedDate, selectedService);
                  }
                }
                
                // Reset form and selection styles
                this.reset();
                serviceOptions.forEach(opt => opt.classList.remove('selected'));
                selectedServiceInput.value = '';
                selectedPriceInput.value = '';
                
                // Reset time selection
                resetTimeSelection();
                
                // Reset button
                submitBtn.textContent = 'Book Appointment';
                submitBtn.disabled = false;
              } else {
                if (data.error && data.error.includes('Time slot already booked')) {
                  document.getElementById('booking-error').textContent = 'Sorry, that time slot is already booked. Please choose another time.';
                  document.getElementById('booking-error').style.display = 'block';
                } else if (data.error && data.error.includes('not available for booking')) {
                  document.getElementById('booking-error').textContent = 'This time slot is not available for booking. Please choose another time.';
                  document.getElementById('booking-error').style.display = 'block';
                } else {
                  document.getElementById('booking-error').textContent = 'Booking failed to save: ' + (data.error || 'Unknown error');
                  document.getElementById('booking-error').style.display = 'block';
                }
                waTab.close(); // Close WhatsApp tab if booking fails
                // Reset button
                submitBtn.textContent = 'Book Appointment';
                submitBtn.disabled = false;
              }
            })
            .catch(error => {
              clearTimeout(timeoutId); // Clear timeout on error
              console.error('Fetch error:', error);
              let errorMessage = 'Network error occurred while booking. ';
              
              if (error.name === 'TypeError' && error.message.includes('fetch')) {
                errorMessage += 'Please check your internet connection and try again.';
              } else if (error.name === 'AbortError') {
                errorMessage += 'Request was cancelled. Please try again.';
              } else {
                errorMessage += 'Please try again in a few moments.';
              }
              
              document.getElementById('booking-error').textContent = errorMessage;
              document.getElementById('booking-error').style.display = 'block';
              waTab.close();
              // Reset button
              submitBtn.textContent = 'Book Appointment';
              submitBtn.disabled = false;
            });
          });
        });
        

        </script>
        
        
        

    
        


    
</body>
</html> 