<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>King Taper - Admin</title>
    <link rel="stylesheet" href="new.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="new.js"></script>
    <style>
        /* Container and typography */
        .admin-container { max-width: 1100px; margin: 4rem auto; padding: 2rem; background: var(--light); border-radius: var(--radius); box-shadow: var(--shadow); }
        .admin-title { text-align: center; color: var(--accent); font-size: 2.5rem; margin-bottom: 2rem; }
        .error-message { color: #ff6b6b; text-align: center; margin-bottom: 1rem; }
        /* Login form */
        .admin-login { max-width: 400px; margin: 3rem auto; background: var(--primary); color: var(--light); padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow); }
        .admin-login label { font-weight: bold; margin-bottom: 0.5rem; display: block; }
        .admin-login input { width: 100%; padding: 0.75rem; margin-bottom: 1.5rem; border: 2px solid var(--accent); border-radius: var(--radius); font-size: 1rem; }
        .admin-login button { width: 100%; padding: 1rem; background: var(--accent); color: var(--primary); border: none; border-radius: var(--radius); font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .admin-login button:hover { background: var(--gold-dark); color: var(--light); }
        /* Dashboard table */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 2rem; }
        .admin-table th, .admin-table td { border: 1px solid var(--accent); padding: 0.75rem 1rem; text-align: left; }
        .admin-table th { background: var(--primary); color: var(--accent); }
        .admin-table tr:nth-child(even) { background: #f9f9f9; }
        /* Buttons */
        .logout-btn { float: right; margin-bottom: 1rem; background: var(--accent); color: var(--primary); border: none; border-radius: var(--radius); padding: 0.5rem 1.5rem; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .logout-btn:hover { background: var(--gold-dark); color: var(--light); }
        /* Modal styles */
        #booking-modal, #blocked-day-modal { display: none; position: fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; }
        #booking-modal .modal-content, #blocked-day-modal .modal-content { background:#fff; padding:2rem; border-radius:8px; max-width:500px; margin:auto; position:relative; }
        #booking-modal .close-btn, #blocked-day-modal .close-btn { position:absolute; top:1rem; right:1rem; font-size:1.5rem; background:none; border:none; cursor:pointer; }
        #booking-modal .form-group, #blocked-day-modal .form-group { margin-bottom:1rem; }
        #booking-modal label, #blocked-day-modal label { display:block; margin-bottom:0.3rem; }
        #booking-modal input, #booking-modal textarea, #blocked-day-modal input, #blocked-day-modal textarea { width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px; }
        #booking-modal button, #blocked-day-modal button { padding:0.7rem 1rem; background: var(--accent); color: var(--primary); border:none; border-radius:var(--radius); cursor:pointer; }
    </style>
</head>
<body>
    <nav class="navbar">
        <!-- Nav content omitted for brevity -->
    </nav>
    <div class="admin-container">
        <div class="admin-title">Admin Dashboard</div>

        <!-- Login Section -->
        <div id="admin-login-section" class="admin-login">
            <div id="login-error" class="error-message" style="display:none;"></div>
            <form id="admin-login-form" method="POST">
                <label for="admin-username">Username</label>
                <input type="text" id="admin-username" name="username" required>
                <label for="admin-password">Password</label>
                <input type="password" id="admin-password" name="password" required>
                <button type="submit">Login</button>
            </form>
        </div>

        <!-- Dashboard Section -->
        <div id="admin-dashboard-section" style="display:none;">
            <button id="logout-btn" class="logout-btn">Logout</button>
            <div style="margin-bottom:1rem;">
                <label for="filter-start">Start Date:</label>
                <input type="date" id="filter-start">
                <label for="filter-end">End Date:</label>
                <input type="date" id="filter-end">
                <button id="filter-btn">Filter</button>
                <button id="clear-filter-btn">Clear</button>
            </div>
            
            <!-- Blocked Days Management -->
            <div style="margin-bottom:2rem; padding:1rem; background:#f5f5f5; border-radius:8px;">
                <h3 style="margin-top:0; color:var(--primary);">Blocked Days Management</h3>
                <div style="margin-bottom:1rem;">
                    <button id="add-blocked-day-btn" style="background: var(--accent); color: var(--primary); border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;">Add Blocked Day</button>
                    <button id="refresh-blocked-days-btn" style="background: var(--primary); color: var(--accent); border: 1px solid var(--accent); padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Refresh</button>
                </div>
                <table class="admin-table" id="blocked-days-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Time Range</th>
                            <th>Reason</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <table class="admin-table" id="bookings-table">
                <thead>
                    <tr>
                        <th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Service</th><th>Price</th><th>Date</th><th>Time</th><th>Notes</th><th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <!-- Blocked Day Modal -->
            <div id="blocked-day-modal" style="display: none;">
              <div class="modal-content">
                <button class="close-btn" id="close-blocked-modal-btn">&times;</button>
                <h2 id="blocked-modal-title">Add Blocked Day</h2>
                <form id="blocked-day-form">
                  <input type="hidden" id="blocked-modal-id">
                  <div class="form-group">
                    <label>Date *</label>
                    <input id="blocked-modal-date" type="date" required>
                  </div>
                  <div class="form-group">
                    <label>
                      <input type="checkbox" id="blocked-modal-whole-day" onchange="toggleTimeFields()"> Block entire day
                    </label>
                  </div>
                  <div id="time-fields">
                    <div class="form-group">
                      <label>Start Time</label>
                      <input id="blocked-modal-start-time" type="time">
                    </div>
                    <div class="form-group">
                      <label>End Time</label>
                      <input id="blocked-modal-end-time" type="time">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Reason</label>
                    <input id="blocked-modal-reason" placeholder="e.g., Holiday, Event, Maintenance">
                  </div>
                  <button type="submit">Save</button>
                </form>
              </div>
            </div>
        </div>

        <!-- Booking Modal -->
        <div id="booking-modal">
          <div class="modal-content">
            <button class="close-btn" id="close-modal-btn">&times;</button>
            <h2>Edit Booking</h2>
            <form id="edit-booking-form">
              <input type="hidden" id="modal-id">
              <div class="form-group"><label>Name</label><input id="modal-name" required></div>
              <div class="form-group"><label>Email</label><input id="modal-email" type="email"></div>
              <div class="form-group"><label>Phone</label><input id="modal-phone"></div>
              <div class="form-group"><label>Service</label><input id="modal-service"></div>
              <div class="form-group"><label>Price</label><input id="modal-price" type="number"></div>
              <div class="form-group"><label>Date</label><input id="modal-date" type="date" required></div>
              <div class="form-group"><label>Time</label><input id="modal-time" type="time" required></div>
              <div class="form-group"><label>Notes</label><textarea id="modal-message"></textarea></div>
              <button type="submit">Save Changes</button>
            </form>
          </div>
        </div>

    </div>

    <script>
        // Use the dynamic configuration with fallback
        let API_BASE_URL;
        if (window.KingTaperConfig && window.KingTaperConfig.apiBaseUrl) {
            API_BASE_URL = window.KingTaperConfig.apiBaseUrl;
        } else {
            // Fallback configuration
            if (window.location.hostname === 'localhost') {
                API_BASE_URL = 'http://localhost:3001';
            } else {
                API_BASE_URL = window.location.origin;
            }
        }
        window.API_BASE_URL = API_BASE_URL;

        console.log('🔧 Admin Configuration:', { 
            KingTaperConfig: window.KingTaperConfig,
            API_BASE_URL: window.API_BASE_URL,
            hostname: window.location.hostname
        });

        // Elements
        const loginForm = document.getElementById('admin-login-form');
        const loginError = document.getElementById('login-error');
        const loginSection = document.getElementById('admin-login-section');
        const dashboardSection = document.getElementById('admin-dashboard-section');
        const logoutBtn = document.getElementById('logout-btn');
        const filterStart = document.getElementById('filter-start');
        const filterEnd = document.getElementById('filter-end');
        const filterBtn = document.getElementById('filter-btn');
        const clearFilterBtn = document.getElementById('clear-filter-btn');
        const tableBody = document.querySelector('#bookings-table tbody');
        const modal = document.getElementById('booking-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const editForm = document.getElementById('edit-booking-form');

        // Show/hide
        function showDashboard() { 
            loginSection.style.display='none'; 
            dashboardSection.style.display='block'; 
            loadBookings(); 
        }
        function showLogin() { dashboardSection.style.display='none'; loginSection.style.display='block'; }

        // Login handler
        loginForm.addEventListener('submit', e => {
            e.preventDefault();
            loginError.style.display = 'none';
            
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            
            console.log('🔐 Login attempt:', { username, password });
            console.log('🌐 API Base URL:', window.API_BASE_URL);
            
            fetch(`${window.API_BASE_URL}/api/admin/login`, {
                method:'POST', credentials:'include',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({ user: username, pass: password })
            })
            .then(r => {
                console.log('📡 Response status:', r.status);
                return r.json();
            })
            .then(data => {
                console.log('📋 Response data:', data);
                if (data.success) {
                    console.log('✅ Login successful!');
                    showDashboard();
                } else {
                    console.log('❌ Login failed:', data.error);
                    loginError.textContent = data.error;
                    loginError.style.display = 'block';
                }
            })
            .catch(err => {
                console.error('🚨 Login error:', err);
                loginError.textContent = 'Server error: ' + err.message;
                loginError.style.display = 'block';
            });
        });

        // Logout handler
        logoutBtn.onclick = () => fetch(`${window.API_BASE_URL}/api/admin/logout`, { method:'POST', credentials:'include' }).then(showLogin);

        // Load bookings
        async function loadBookings() {
            let url = `${window.API_BASE_URL}/api/admin/bookings`;
            const start = filterStart.value, end = filterEnd.value;
            if (start && end) url += `?start=${start}&end=${end}`;
            tableBody.innerHTML = '<tr><td colspan="10">Loading...</td></tr>';
            try {
                const res = await fetch(url, { credentials:'include' });
                if (res.status===401) return showLogin();
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Loading error');
                tableBody.innerHTML = data.bookings.length
                    ? data.bookings.map(b => `<tr>
                        <td>${b.id}</td><td>${b.name}</td><td>${b.email}</td>
                        <td>${b.phone}</td><td>${b.service}</td><td>${b.price}</td>
                        <td>${new Date(b.date).toLocaleDateString()}</td><td>${b.time}</td>
                        <td>${b.message||''}</td>
                        <td>
                            <button class="edit-btn" data-id="${b.id}">Edit</button>
                            <button class="delete-btn" data-id="${b.id}">Delete</button>
                        </td>
                    </tr>`).join('')
                    : '<tr><td colspan="10">No bookings found.</td></tr>';
            } catch (err) {
                tableBody.innerHTML = `<tr><td colspan="10">${err.message}</td></tr>`;
            }
        }

        // Filter
        filterBtn.onclick = () => { loadBookings(); };
        clearFilterBtn.onclick = () => { 
            filterStart.value=''; 
            filterEnd.value=''; 
            loadBookings(); 
        };

        // Modal & edit
        tableBody.addEventListener('click', e => {
            if (e.target.classList.contains('edit-btn')) {
                const id = e.target.dataset.id;
                // find booking data from table row or re-fetch single entry
                // For simplicity, re-fetch all and find
                fetch(`${window.API_BASE_URL}/api/admin/bookings`, { credentials:'include' })
                .then(r=>r.json()).then(data=>{
                    const booking = data.bookings.find(b=>b.id==id);
                    if (!booking) return;
                    document.getElementById('modal-id').value = booking.id;
                    ['name','email','phone','service','price','date','time','message'].forEach(field => {
                        const el = document.getElementById(`modal-${field}`);
                        if (el) el.value = field==='date' ? booking.date.split('T')[0] : booking[field];
                    });
                    modal.style.display = 'flex';
                });
            }
            if (e.target.classList.contains('delete-btn')) {
                const id = e.target.dataset.id;
                if (confirm('Delete booking #' + id + '?')) {
                    fetch(`${window.API_BASE_URL}/api/admin/bookings/${id}`, { method:'DELETE', credentials:'include' })
                    .then(()=>loadBookings());
                }
            }
        });

        closeModalBtn.onclick = () => modal.style.display='none';
        editForm.addEventListener('submit', e => {
            e.preventDefault();
            const id = document.getElementById('modal-id').value;
            const body = {};
            ['name','email','phone','service','price','date','time','message'].forEach(field => {
                body[field] = document.getElementById(`modal-${field}`).value;
            });
            fetch(`${window.API_BASE_URL}/api/admin/bookings/${id}`, { method:'PUT', credentials:'include', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) })
            .then(r=>r.json()).then(()=>{
                modal.style.display='none';
                loadBookings();
            });
        });

        // Blocked Days Management
        const blockedDaysTable = document.querySelector('#blocked-days-table tbody');
        const blockedDayModal = document.getElementById('blocked-day-modal');
        const blockedDayForm = document.getElementById('blocked-day-form');
        const closeBlockedModalBtn = document.getElementById('close-blocked-modal-btn');
        const addBlockedDayBtn = document.getElementById('add-blocked-day-btn');
        const refreshBlockedDaysBtn = document.getElementById('refresh-blocked-days-btn');

        // Toggle time fields based on whole day checkbox
        function toggleTimeFields() {
            const wholeDayCheckbox = document.getElementById('blocked-modal-whole-day');
            const timeFields = document.getElementById('time-fields');
            const startTimeInput = document.getElementById('blocked-modal-start-time');
            const endTimeInput = document.getElementById('blocked-modal-end-time');
            
            if (wholeDayCheckbox.checked) {
                timeFields.style.display = 'none';
                startTimeInput.required = false;
                endTimeInput.required = false;
            } else {
                timeFields.style.display = 'block';
                startTimeInput.required = true;
                endTimeInput.required = true;
            }
        }

        // Load blocked days
        async function loadBlockedDays() {
            try {
                const res = await fetch(`${window.API_BASE_URL}/api/admin/blocked-days`, { credentials: 'include' });
                const data = await res.json();
                
                if (data.success) {
                    blockedDaysTable.innerHTML = '';
                    data.blockedDays.forEach(blockedDay => {
                        const row = document.createElement('tr');
                        const type = blockedDay.is_whole_day ? 'Whole Day' : 'Time Range';
                        const timeRange = blockedDay.is_whole_day ? 'All Day' : 
                            (blockedDay.start_time && blockedDay.end_time ? 
                                `${blockedDay.start_time} - ${blockedDay.end_time}` : 'N/A');
                        
                        row.innerHTML = `
                            <td>${blockedDay.date}</td>
                            <td>${type}</td>
                            <td>${timeRange}</td>
                            <td>${blockedDay.reason || 'No reason provided'}</td>
                            <td>
                                <button onclick="editBlockedDay(${blockedDay.id})" style="background: var(--accent); color: var(--primary); border: none; padding: 0.3rem 0.6rem; border-radius: 3px; cursor: pointer; margin-right: 0.3rem;">Edit</button>
                                <button onclick="deleteBlockedDay(${blockedDay.id})" style="background: #ff6b6b; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 3px; cursor: pointer;">Delete</button>
                            </td>
                        `;
                        blockedDaysTable.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading blocked days:', error);
            }
        }

        // Add blocked day
        addBlockedDayBtn.onclick = () => {
            document.getElementById('blocked-modal-title').textContent = 'Add Blocked Day';
            blockedDayForm.reset();
            document.getElementById('blocked-modal-whole-day').checked = false;
            toggleTimeFields();
            blockedDayModal.style.display = 'flex';
        };

        // Edit blocked day
        window.editBlockedDay = async (id) => {
            try {
                const res = await fetch(`${window.API_BASE_URL}/api/admin/blocked-days`, { credentials: 'include' });
                const data = await res.json();
                const blockedDay = data.blockedDays.find(bd => bd.id === id);
                
                if (blockedDay) {
                    document.getElementById('blocked-modal-title').textContent = 'Edit Blocked Day';
                    document.getElementById('blocked-modal-id').value = blockedDay.id;
                    document.getElementById('blocked-modal-date').value = blockedDay.date;
                    document.getElementById('blocked-modal-whole-day').checked = blockedDay.is_whole_day;
                    document.getElementById('blocked-modal-start-time').value = blockedDay.start_time || '';
                    document.getElementById('blocked-modal-end-time').value = blockedDay.end_time || '';
                    document.getElementById('blocked-modal-reason').value = blockedDay.reason || '';
                    toggleTimeFields();
                    blockedDayModal.style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading blocked day:', error);
            }
        };

        // Delete blocked day
        window.deleteBlockedDay = async (id) => {
            if (confirm('Are you sure you want to delete this blocked day?')) {
                try {
                    const res = await fetch(`${window.API_BASE_URL}/api/admin/blocked-days/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    const data = await res.json();
                    if (data.success) {
                        loadBlockedDays();
                    } else {
                        alert('Error deleting blocked day: ' + data.error);
                    }
                } catch (error) {
                    console.error('Error deleting blocked day:', error);
                    alert('Error deleting blocked day');
                }
            }
        };

        // Blocked day form submission
        blockedDayForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                date: document.getElementById('blocked-modal-date').value,
                isWholeDay: document.getElementById('blocked-modal-whole-day').checked,
                startTime: document.getElementById('blocked-modal-start-time').value || null,
                endTime: document.getElementById('blocked-modal-end-time').value || null,
                reason: document.getElementById('blocked-modal-reason').value || null
            };

            const id = document.getElementById('blocked-modal-id').value;
            const url = id ? `${window.API_BASE_URL}/api/admin/blocked-days/${id}` : `${window.API_BASE_URL}/api/admin/blocked-days`;
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await res.json();
                if (data.success) {
                    blockedDayModal.style.display = 'none';
                    loadBlockedDays();
                } else {
                    alert('Error saving blocked day: ' + data.error);
                }
            } catch (error) {
                console.error('Error saving blocked day:', error);
                alert('Error saving blocked day');
            }
        });

        // Close blocked day modal
        closeBlockedModalBtn.onclick = () => blockedDayModal.style.display = 'none';
        refreshBlockedDaysBtn.onclick = loadBlockedDays;

        // Auto-check login on load
        fetch(`${window.API_BASE_URL}/api/admin/bookings`, { credentials:'include' })
        .then(res => { 
            if (res.ok) {
                showDashboard();
                loadBlockedDays(); // Load blocked days when dashboard is shown
            } else {
                showLogin();
            }
        });
    </script>
</body>
</html>
